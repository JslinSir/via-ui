const DATETIMEENUM={YEAR:0,MONTH:1,DAY:2,HH:3,MM:4,SS:5},TIMEENUM={HH:0,MM:1,SS:2};import datepicker from"./behavior";import{unitZero,createArray}from"../utils/base";const HOUR=createArray(24),MIN=createArray(60),SECOND=createArray(60);Component({behaviors:[datepicker],options:{},properties:{},data:{years:[],months:[],days:[],hour:HOUR,min:MIN,second:SECOND,selectedValue:[],forbidden:null,selectPickerText:""},observers:{mode(e){e&&this.setData({_mode:e})},selectedValue(e){const{_mode:t}=this.data;this._toRenderExe()[`${t}Change`].call(this,e,!1)}},methods:{render(e){this._renderPicker(!0,e)},_renderPicker(e,t){const{_mode:a}=this.data;this._toRenderExe()[a].call(this,e,t)},_toRenderExe(){return{date:this._renderDate,time:this._renderTime,dateTime:this._renderDateTime,dateChange:this._renderDateChange,timeChange:this._renderTimeChange,dateTimeChange:this._renderDateTimeChange}},_renderDate(e=!0,t){const a=new Date,{beginRange:r,endRange:n}=this.properties,s=a.getFullYear(),i=s-r,h=createArray(r+n+1).map((e=>i+e)),o=t||this.data.value,l=o[0]?parseInt(o[DATETIMEENUM.YEAR]):s,c=o[1]?parseInt(o[DATETIMEENUM.MONTH]):a.getMonth()+1,d=o[2]?parseInt(o[DATETIMEENUM.DAY]):a.getDate();this.year=l,this.month=c;const m=this._setMonths(12),E=this._setDays(l,c),T=h.indexOf(l),M=m.indexOf(c),g=E.indexOf(d);if(this.confimValue=[l,c,d],!e)return{years:h,months:m,days:E,yearIndex:T,monthIndex:M,dayIndex:g};this.setData({years:h,months:m,days:E}),wx.nextTick((()=>{this.setData({selectedValue:[T,M,g]})})),this.pickerStatus=!1},_renderTime(e=!0,t,a=TIMEENUM){const r=t||this.data.value,n=r[a.HH]?parseInt(r[a.HH]):0,s=r[a.MM]?parseInt(r[a.MM]):0,i=r[a.SS]?parseInt(r[a.SS]):0,h=HOUR.indexOf(n),o=MIN.indexOf(s),l=SECOND.indexOf(i);if(this.confimValue=[n,s,i],!e)return[h,o,l];this.setData({selectedValue:[h,o,l]})},_renderDateTime(e){const{years:t,months:a,days:r,yearIndex:n,monthIndex:s,dayIndex:i}=this._renderDate(!1,e),h=this._renderTime(!1,e,DATETIMEENUM);this.setData({years:t,months:a,days:r}),wx.nextTick((()=>{this.setData({selectedValue:[n,s,i,...h]})})),this.pickerStatus=!1},_setMonths:e=>createArray(e).map((e=>e+1)),_setDays(e,t){t=parseInt(t,10);const a=new Date(e,t,0).getDate();return createArray(a).map((e=>e+1))},pickerChangeStart(){this.pickerStatus=!0,this.setData({forbidden:"forbidden"})},pickerChangeEnd(){setTimeout((()=>{this.pickerStatus=!1,this.setData({forbidden:null})}),100)},pickerChange(e){const t=e.detail.value,{_mode:a}=this.data;this._changeEffetc(t,a)},_changeEffetc(e,t){const{year:a,month:r}=this._getSelectArrayVal(e);let n=!1,s=e;"time"!=t&&(this.year!==a&&(s[DATETIMEENUM.MONTH]=0,s[DATETIMEENUM.DAY]=0,n=!0),this.month!==r&&(s[DATETIMEENUM.DAY]=0,n=!0)),n&&this.setData({selectedValue:s}),this._toRenderExe()[`${t}Change`].call(this,s)},_renderDateChange(e,t=!0){const{val:a,text:r,year:n,month:s}=this._getSelectArrayVal(e);this.year=n,this.month=s,this.triggerEvent("onChange",{value:a,flag:t,selectPickerText:r})},_renderTimeChange(e,t=!0){const{val:a,text:r}=this._getSelectArrayVal(e);this.triggerEvent("onChange",{flag:t,selectPickerText:r,value:a})},_renderDateTimeChange(e,t=!0){const{val:a,text:r,year:n,month:s}=this._getSelectArrayVal(e);this.year=n,this.month=s,this.triggerEvent("onChange",{flag:t,selectPickerText:r,value:a})},_getSelectArrayVal(e){const{years:t,months:a,days:r,isUnitZero:n,dateTextFormatChart:s,dateValFormatChart:i,timeTextFormatChart:h,timeValFormatChart:o,_mode:l}=this.data;return this._getSelectArrayVal.dateCacularVal=()=>{const h=t[e[DATETIMEENUM.YEAR]];let o=a[e[DATETIMEENUM.MONTH]],l=r[e[DATETIMEENUM.DAY]];n&&(o=unitZero(o),l=unitZero(l));const c=[h,o,l].join(i),d=[h,o,l].join(s);return this._confirm=c,{val:c,text:d,year:h,month:o}},this._getSelectArrayVal.timeCacularVal=(t=TIMEENUM)=>{let a=HOUR[e[t.HH]],r=MIN[e[t.MM]],s=SECOND[e[t.SS]];n&&(a=unitZero(a),r=unitZero(r),s=unitZero(s));const i=[a,r,s].join(o),l=[a,r,s].join(h);return this._confirm=i,{val:i,text:l}},this._getSelectArrayVal.dateTimeCacularVal=()=>{const e=this._getSelectArrayVal.dateCacularVal(),t=this._getSelectArrayVal.timeCacularVal(DATETIMEENUM);return this._confirm=`${e.val} ${t.val}`,{val:this._confirm,text:`${e.text} ${t.text}`,year:e.year,month:e.month}},this._getSelectArrayVal[`${l}CacularVal`]()},handleConfirm(e){!1===this.pickerStatus&&this.triggerEvent("onConfirm",{value:this._confirm})},handleReset(){this.triggerEvent("onRest","")}}});